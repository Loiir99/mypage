<!DOCTYPE html>
<html>
<head>
    <title>Balloon Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.1.0/mqtt.min.js"></script>
    <script>
        var client;

        function connectMQTT() {
            client = mqtt.connect('wss://test.mosquitto.org:8081/mqtt');
            client.on('connect', function () {
                console.log('Connected to MQTT broker');
                client.subscribe('balloon/size');
            });
            client.on('message', function (topic, message) {
                if (topic === 'balloon/size') {
                    document.getElementById('currentSize').innerText = message.toString() + '%';
                }
            });
            client.on('error', function (err) {
                console.error('Connection error: ', err);
            });
        }

        function sendMessage(topic, message) {
            if (client && client.connected) {
                client.publish(topic, message);
                console.log('Message sent: ', message);
            } else {
                console.error('MQTT client is not connected');
            }
        }

        function setBalloonSize() {
            var size = document.getElementById('sizeInput').value;
            if (size >= 0 && size <= 100) {
                sendMessage('balloon/control', 'size:' + size);
            } else {
                alert('Please enter a size between 0 and 100');
            }
        }

        function addFivePercent() {
            sendMessage('balloon/control', 'add:5');
        }

        function releaseValve() {
            sendMessage('balloon/control', 'release');
        }

        window.onload = function() {
            connectMQTT();
        }

        function showProgrammingPage() {
            document.getElementById('controlPage').style.display = 'none';
            document.getElementById('programmingPage').style.display = 'block';
        }

        function showControlPage() {
            document.getElementById('controlPage').style.display = 'block';
            document.getElementById('programmingPage').style.display = 'none';
        }

        function startProgram() {
            var steps = parseInt(document.getElementById('steps').value);
            var maxSize = parseInt(document.getElementById('maxSize').value);
            var holdTime = parseInt(document.getElementById('holdTime').value) * 1000;
            var pauseTime = parseInt(document.getElementById('pauseTime').value) * 1000;
            var restTime = parseInt(document.getElementById('restTime').value) * 1000;
            var repeats = parseInt(document.getElementById('repeats').value);
            var programType = document.getElementById('programType').value;

            var sizeIncrement = Math.floor(maxSize / steps);

            function runStep(currentStep, repeat) {
                if (currentStep <= steps) {
                    var targetSize = sizeIncrement * currentStep;
                    sendMessage('balloon/control', 'size:' + targetSize);
                    setTimeout(function() {
                        if (programType === "example3" && currentStep === steps) {
                            sendMessage('balloon/control', 'release');
                            setTimeout(function() {
                                runStep(currentStep + 1, repeat);
                            }, restTime);
                        } else {
                            runStep(currentStep + 1, repeat);
                        }
                    }, holdTime);
                } else {
                    sendMessage('balloon/control', 'release');
                    if (repeat < repeats) {
                        setTimeout(function() {
                            runStep(1, repeat + 1);
                        }, pauseTime);
                    }
                }
            }

            runStep(1, 1);
        }
    </script>
</head>
<body>
    <div id="controlPage">
        <h1>Balloon Control</h1>
        <label for="sizeInput">Balloon Size (%):</label>
        <input type="number" id="sizeInput" name="sizeInput" min="0" max="100">
        <button onclick="setBalloonSize()">Set Size</button>
        <br><br>
        <button onclick="addFivePercent()">Add 5%</button>
        <br><br>
        <button onclick="releaseValve()">Release Valve</button>
        <br><br>
        <h2>Current Balloon Size: <span id="currentSize">0%</span></h2>
        <br><br>
        <button onclick="showProgrammingPage()">Go to Programming Page</button>
    </div>

    <div id="programmingPage" style="display:none;">
        <h1>Balloon Programming</h1>
        <label for="steps">Number of Steps to Max Size:</label>
        <input type="number" id="steps" name="steps" min="1" required>
        <br><br>
        <label for="maxSize">Max Size (%):</label>
        <input type="number" id="maxSize" name="maxSize" min="1" max="100" required>
        <br><br>
        <label for="holdTime">Hold Time Between Steps (seconds):</label>
        <input type="number" id="holdTime" name="holdTime" min="1" required>
        <br><br>
        <label for="pauseTime">Pause Time After Full Cycle (seconds):</label>
        <input type="number" id="pauseTime" name="pauseTime" min="1" required>
        <br><br>
        <label for="restTime">Rest Time at 0% (seconds):</label>
        <input type="number" id="restTime" name="restTime" min="1" required>
        <br><br>
        <label for="repeats">Number of Repeats:</label>
        <input type="number" id="repeats" name="repeats" min="1" required>
        <br><br>
        <label for="programType">Program Type:</label>
        <select id="programType" name="programType">
            <option value="example1">Example 1</option>
            <option value="example2">Example 2</option>
            <option value="example3">Example 3</option>
        </select>
        <br><br>
        <button onclick="startProgram()">Start Program</button>
        <br><br>
        <button onclick="showControlPage()">Back to Control Page</button>
    </div>
</body>
</html>
