<!DOCTYPE html>
<html>
<head>
    <title>Balloon Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.1.0/mqtt.min.js"></script>
    <style>
        #loginContainer {
            display: block;
        }
        #mainContainer, #programmingContainer, #randomProgramContainer {
            display: none;
        }
    </style>
    <script>
        let client;
        let topic = "balloon/control";
        let currentSize = 0;
        let stopFlag = false;
        const correctPassword = "1234";

        function setupMQTT() {
            client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");
            client.on("connect", function () {
                console.log("Connected to MQTT broker");
                client.subscribe(topic);
            });

            client.on("message", function (topic, message) {
                console.log("Message: " + message.toString());
                if (message.toString().startsWith("currentSize:")) {
                    currentSize = parseInt(message.toString().substring(12));
                    document.getElementById("currentSizeDisplay").innerText = currentSize + "%";
                }
            });
        }

        function sendCommand(command) {
            client.publish(topic, command);
        }

        function setBalloonSize() {
            let size = document.getElementById("sizeInput").value;
            sendCommand("size:" + size);
        }

        function addBalloonSize() {
            sendCommand("add:5");
        }

        function releaseValve() {
            sendCommand("release");
        }

        function stopProgram() {
            stopFlag = true;
            releaseValve();
        }

        function startProgram() {
            stopFlag = false;

            let maxSteps = parseInt(document.getElementById("stepsInput").value);
            let maxSize = parseInt(document.getElementById("maxSizeInput").value);
            let holdTime = parseInt(document.getElementById("holdTimeInput").value) * 1000;
            let restTime = parseInt(document.getElementById("restTimeInput").value) * 1000;
            let pauseTime = parseInt(document.getElementById("pauseTimeInput").value) * 1000;
            let repetitions = parseInt(document.getElementById("repetitionsInput").value);
            let programType = document.getElementById("programType").value;

            async function runProgram() {
                if (stopFlag) return;

                if (programType === "1") {
                    for (let i = 1; i <= repetitions; i++) {
                        for (let step = 1; step <= maxSteps; step++) {
                            if (stopFlag) return;
                            let size = Math.round((maxSize / maxSteps) * step);
                            sendCommand("size:" + size);
                            await sleep(holdTime);
                        }
                        if (stopFlag) return;
                        await sleep(restTime);
                        releaseValve();
                        await sleep(pauseTime);
                    }
                } else if (programType === "2") {
                    for (let i = 1; i <= repetitions; i++) {
                        for (let step = 1; step <= maxSteps; step++) {
                            if (stopFlag) return;
                            let size = Math.round((maxSize / maxSteps) * step);
                            sendCommand("size:" + size);
                            await sleep(holdTime);
                            releaseValve();
                            await sleep(pauseTime);
                        }
                    }
                } else if (programType === "3") {
                    for (let i = 1; i <= repetitions; i++) {
                        for (let step = 1; step <= maxSteps; step++) {
                            if (stopFlag) return;
                            let size = Math.round((maxSize / maxSteps) * step);
                            sendCommand("size:" + size);
                            await sleep(holdTime);
                            releaseValve();
                            await sleep(pauseTime);
                            sendCommand("size:" + size);
                            await sleep(holdTime);
                            releaseValve();
                            await sleep(pauseTime);
                        }
                    }
                }
            }

            runProgram();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function login() {
            const password = document.getElementById("passwordInput").value;
            if (password === correctPassword) {
                document.getElementById("loginContainer").style.display = "none";
                document.getElementById("mainContainer").style.display = "block";
            } else {
                alert("Incorrect password!");
            }
        }

        function showMainPage() {
            document.getElementById("programmingContainer").style.display = "none";
            document.getElementById("randomProgramContainer").style.display = "none";
            document.getElementById("mainContainer").style.display = "block";
        }

        function showProgrammingPage() {
            document.getElementById("mainContainer").style.display = "none";
            document.getElementById("programmingContainer").style.display = "block";
        }

        function showRandomProgramPage() {
            document.getElementById("mainContainer").style.display = "none";
            document.getElementById("randomProgramContainer").style.display = "block";
        }

        async function startRandomProgram() {
            stopFlag = false;

            let duration = parseInt(document.getElementById("randomDuration").value) * 1000;
            let maxSize = parseInt(document.getElementById("randomMaxSize").value);
            let startTime = Date.now();

            async function runRandomProgram() {
                while (!stopFlag && Date.now() - startTime < duration) {
                    if (stopFlag) return;

                    let size = Math.floor(Math.random() * maxSize) + 1;
                    let holdTime = Math.floor(Math.random() * 5000) + 1000; // Hold between 1 and 5 seconds

                    sendCommand("size:" + size);
                    await sleep(holdTime);
                }
                releaseValve();
            }

            runRandomProgram();
        }

        document.addEventListener('DOMContentLoaded', setupMQTT);
    </script>
</head>
<body>
    <div id="loginContainer">
        <h1>Login</h1>
        <label for="passwordInput">Password: </label>
        <input type="password" id="passwordInput">
        <button onclick="login()">Login</button>
    </div>

    <div id="mainContainer">
        <h1>Balloon Control</h1>
        <div>
            <label for="sizeInput">Set Balloon Size (%): </label>
            <input type="number" id="sizeInput" min="0" max="100">
            <button onclick="setBalloonSize()">Set Size</button>
        </div>
        <div>
            <button onclick="addBalloonSize()">Add 5%</button>
        </div>
        <div>
            <button onclick="releaseValve()">Release Valve</button>
        </div>
        <div>
            <span>Current Balloon Size: </span>
            <span id="currentSizeDisplay">0%</span>
        </div>
        <div>
            <button onclick="stopProgram()">Stop Program</button>
        </div>
        <div>
            <button onclick="showProgrammingPage()">Programming</button>
        </div>
        <div>
            <button onclick="showRandomProgramPage()">Random Program</button>
        </div>
    </div>

    <div id="programmingContainer">
        <h1>Programming</h1>
        <h2>Program Settings</h2>
        <div>
            <label for="stepsInput">Number of Steps: </label>
            <input type="number" id="stepsInput" min="1">
        </div>
        <div>
            <label for="maxSizeInput">Max Size (%): </label>
            <input type="number" id="maxSizeInput" min="1" max="100">
        </div>
        <div>
            <label for="holdTimeInput">Hold Time (seconds): </label>
            <input type="number" id="holdTimeInput" min="1">
        </div>
        <div>
            <label for="restTimeInput">Rest Time (seconds): </label>
            <input type="number" id="restTimeInput" min="1">
        </div>
        <div>
            <label for="pauseTimeInput">Pause Time (seconds): </label>
            <input type="number" id="pauseTimeInput" min="1">
        </div>
        <div>
            <label for="repetitionsInput">Number of Repetitions: </label>
            <input type="number" id="repetitionsInput" min="1">
        </div>
        <div>
            <label for="programType">Program Type: </label>
            <select id="programType">
                <option value="1">Example 1</option>
                <option value="2">Example 2</option>
                <option value="3">Example 3</option>
            </select>
        </div>
        <div>
            <button onclick="startProgram()">Start Program</button>
        </div>
        <div>
            <button onclick="showMainPage()">Back to Main</button>
        </div>
    </div>

    <div id="randomProgramContainer">
        <h1>Random Program</h1>
        <div>
            <label for="randomDuration">Duration (seconds): </label>
            <input type="number" id="randomDuration" min="1">
        </div>
        <div>
            <label for="randomMaxSize">Max Size (%): </label>
            <input type="number" id="randomMaxSize" min="1" max="100">
        </div>
        <div>
            <button onclick="startRandomProgram()">Start Random Program</button>
        </div>
        <div>
            <button onclick="showMainPage()">Back to Main</button>
        </div>
    </div>
</body>
</html>

